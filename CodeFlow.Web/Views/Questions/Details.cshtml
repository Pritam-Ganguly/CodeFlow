@model DetailsViewModel

@{
    ViewData["Title"] = Model.Question!.Title;
}

<div class="container mt-4">
    <div class="so-question-card mb-4">
        <div class="so-question-body row">
            @await Html.PartialAsync("_QuestionHeader", Model.Question)
            <hr />
            @await Html.PartialAsync("_VoteSection", Model.Question)
            @await Html.PartialAsync("_QuestionBody", Model.Question)
            @await Html.PartialAsync("_CommentSection", Model.Question)
        </div>
    </div>

    <h5>@(Model.TotalAnswers) @(Model.TotalAnswers == 1 ? "Answer" : " Answers")</h5>

    <div id="AnswersContainer">
        @await Component.InvokeAsync("Answers", new {
                answers = Model.Answers,
                isAuthor = Model.Question.IsAuthor
                })
    </div>

    <div class="mt-3 text-center">
        <button id="LoadMoreAnswersButton" class="btn btn-outline-primary" data-question-id="@Model.Question.Id" data-user-id="@Model.Question.UserId" data-page-size="5" data-page-Number="1">Load More</button>
    </div>
</div>
<div class="mt-5">
    <div class="fw-semibold fs-4 pb-2">You're Answer</div>

    @if(User.Identity?.IsAuthenticated == true)
    {
        <form asp-action="Answer" asp-route-questionId="@Model.Question.Id" method="post">
            @Html.AntiForgeryToken()

            <div class="form-group mb-3 codeflow-editor">
                <textarea id="AnswerBodyEditor" name="bodyMarkDown" class="form-control" rows="6" placeholder="Explain your answer in details..."></textarea>
                @if (ViewData.ModelState["answerbody"]?.Errors.Count > 0)
                {
                    <span class="text-danger">@ViewData.ModelState["answerbody"]?.Errors.First().ErrorMessage</span>
                }
            </div>

            <div class="form-group">
                <input class="btn btn-primary" type="submit" value="Post your answer" />
            </div>
        </form>
    }
    else
    {
        <div class="mb-3">
            <span>Please log in to post answers</span> - <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path"> Login</a>
        </div>
    }
</div>

@section Scripts {
    <script>
        const textAreaId = "AnswerBodyEditor";
        const options = {
            autofocus: false,
            autosave: {
                enabled: true,
                uniqueId: textAreaId,
                delay: 1000,
                text: "Autosaved: "
            },
            blockStyles: {
                italic: "_",
            },
            unorderedListStyle: "-",
            element: document.getElementById(textAreaId),
            forceSync: true,
            hideIcons: ["guide", "fullsceen", "side-by-side"],
            indentWithTabs: false,
            uploadImage: true,
            imageUploadFunction: function(file, onSuccess, onError) {
                const formData = new FormData();
                formData.append("file", file);

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                fetch('/upload/uploadimage', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Upload failed'); });
                    }
                    return response.json();
                })
                .then(data => {
                    onSuccess(data.data.filePath);
                })
                .catch(error => {
                    onError(error.message);
                    console.error('Image upload error:', error);
                });
            },
            insertTexts: {
                horizontalRule: ["", "\n\n-----\n\n"],
                image: ["![](http://", ")"],
                link: ["[", "](https://)"],
                table: ["", "\n\n| Column 1 | Column 2 | Column 3 |\n| -------- | -------- | -------- |\n| Text     | Text      | Text     |\n\n"],
            },
            minHeight: "300px",
            parsingConfig: {
                allowAtxHeaderWithoutSpace: true,
                strikethrough: false,
                underscoresBreakWords: true,
            },
            placeholder: "Describe your problem in detail (Markdown supported..)",
            previewRender: (plainText, preview) => { // Async method
                setTimeout(() => {
                    const formData = new FormData();
                    formData.append("markdown", plainText);

                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    result = fetch(`/questions/RenderMarkDownPreview`, {
                        method: 'POST',
                        headers: {
                            "RequestVerificationToken": token
                        },
                        body: formData
                    })
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        console.log(data.data);
                        preview.innerHTML = data.data;
                        return data.data;
                    })
                    .catch(error => {
                        console.error('Markdown preview error: ', error);
                    })

                }, 2000);

                return "Parsing Markdown...";
            },
            renderingConfig: {
                singleLineBreaks: false,
                codeSyntaxHighlighting: true,
            },
            shortcuts: {
                    drawTable: "Cmd-Alt-T",
                    toggleOrderedList: "Cmd-Alt-O",
                    toggleUnorderedList: "Cmd-Alt-U",
                    toggleCodeBlock: "Cmd-Alt-C",
                    toggleHeadingSmaller: "Cmd-Alt-H",
                    cleanBlock: "Cmd-Alt-E",
            },
            showIcons: ["code", "table", "horizontal-rule", "heading", "heading-bigger", "heading-smaller"],
            spellChecker: false,
            status: false,
            status: ["autosave", "lines", "words", "cursor"],
            styleSelectedText: false,
            sideBySideFullscreen: false,
            syncSideBySidePreviewScroll: false,
            tabSize: 4,
            toolbar: [
                    "bold", "italic", "heading", "|",
                    "code", "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "horizontal-rule", "|",
                    "preview", "side-by-side", "fullscreen", "table"
                ],
            toolbarTips: true,
        }

        document.addEventListener("DOMContentLoaded", function() {
            const easyMDE = new EasyMDE(options);
        })
    </script>
    <script>
        function handleOpen(id){
            document.getElementById(`answer-body-${id}`).style.display = "none";
            document.getElementById(`answer-form-${id}`).style.display = "block";
        }

        function handleClose(id){
            document.getElementById(`answer-body-${id}`).style.display = "block";
            document.getElementById(`answer-form-${id}`).style.display = "none";
        }

        document.addEventListener('DOMContentLoaded', function () {
            const questionArrow = document.getElementById('toggle-comments-arrow');
            const questionCommentsSection = document.getElementById('comments-section');
            let questionCommentsVisible = true;

            if (questionArrow && questionCommentsSection) {
                questionArrow.addEventListener('click', function () {
                    questionCommentsVisible = !questionCommentsVisible;
                    questionCommentsSection.style.display = questionCommentsVisible ? 'block' : 'none';
                    questionArrow.innerHTML = questionCommentsVisible
                        ? '<i class="fa-solid fa-caret-down"></i>'
                        : '<i class="fa-solid fa-caret-right"></i>';
                });
            }

            document.querySelectorAll(".answer-comments-section").forEach(section => {
                const id = section.getAttribute('answer-id');
                const arrow = document.getElementById(`toggle-arrow-${id}`);
                const commentsSection = document.getElementById(`comments-section-answer-${id}`);
                let commentsVisible = true;

                if (arrow && commentsSection) {
                    arrow.addEventListener('click', function () {
                        commentsVisible = !commentsVisible;
                        commentsSection.style.display = commentsVisible ? 'block' : 'none';
                        arrow.innerHTML = commentsVisible
                            ? '<i class="fa-solid fa-caret-down"></i>'
                            : '<i class="fa-solid fa-caret-right"></i>';
                    });
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
                    document.querySelectorAll('.vote-link').forEach((link, i) => {
                        link.addEventListener('click', async function (e) {
                            e.preventDefault();

                            const type = this.dataset.type;
                            const id = parseInt(this.dataset.id);
                            const vote = parseInt(this.dataset.vote);

                            if(vote == 1){
                                document.querySelectorAll('.vote-link')[i].getElementsByTagName('i')[0].style.color = 'grey';
                                document.querySelectorAll('.vote-link')[i+1].getElementsByTagName('i')[0].style.color = 'lightgrey';
                            }
                            else {
                                document.querySelectorAll('.vote-link')[i].getElementsByTagName('i')[0].style.color = 'grey';
                                document.querySelectorAll('.vote-link')[i-1].getElementsByTagName('i')[0].style.color = 'lightgrey';
                            }

                            try {
                                const response = await fetch(`/Votes/${type}?${type}Id=${id}&voteType=${vote}`, {
                                    method: 'POST',
                                    headers: {
                                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                                    }
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    console.log(result);
                                    document.getElementById(`${type}-score-${id}`).textContent = result.newScore;
                                } else {
                                    alert('Failed to register vote. You may have already voted.');
                                }
                            } catch (error) {
                                console.error('Error:', error);
                                alert('An error occurred while voting.');
                            }
                        });
                    });
                });
    </script>
    <script>

        document.getElementById("LoadMoreAnswersButton").addEventListener("click", async (e) => {
            var btn = e.currentTarget;
            var questionId = parseInt(btn.dataset.questionId, 10);
            var userId = parseInt(btn.dataset.userId, 10);
            var pageSize = parseInt(btn.dataset.pageSize, 10);
            var pageNumber = parseInt(btn.dataset.pageNumber, 10) + 1;

            try{
                var response = await fetch(`/Questions/GetMoreAnswers?questionId=${questionId}&userId=${userId}&pageSize=${pageSize}&pageNumber=${pageNumber}`,
                   {
                       method: "GET",
                       headers: {
                           'X-Requested-With': 'XMLHttpRequest'
                       }
                   }
                )
                var container = document.getElementById("AnswersContainer");
                var temp = document.createElement("div");

                if(response.status == 204) {
                    temp.innerHTML = "No more answers to display";
                    if(temp){
                        container.appendChild(temp);
                    }
                    btn.style.display = 'none';
                    return;
                }

                if(!response.ok){
                    console.error("error occurred while loading more answers", e);
                    alert("an error occurred while loading more questions");
                    return;
                }

                var html = await response.text();
                if(!html.trim()){
                    btn.style.display = 'none';
                    return;
                }

                temp.innerHTML = html;
                if(temp){
                    container.appendChild(temp);
                }

                btn.dataset.pageNumber = pageNumber;
            }
            catch{

            }
        })
            
    </script>
}
