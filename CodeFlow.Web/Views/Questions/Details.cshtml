@model DetailsViewModel

@{
    ViewData["Title"] = Model.Question!.Title;
}

<div class="container mt-4">
    <div class="so-question-card mb-4">
        <div class="so-question-body row">
            @await Html.PartialAsync("_QuestionHeader", Model.Question)
            <hr />
            @await Html.PartialAsync("_VoteSection", Model.Question)
            @await Html.PartialAsync("_QuestionBody", Model.Question)
            @await Html.PartialAsync("_CommentSection", Model.Question)
        </div>
    </div>

    @await Component.InvokeAsync("Answers", new {
        answers = Model.Answers,
        isAuthor = Model.Question.IsAuthor
    })

</div>
<div class="mt-5">
    <h4>You're Answer</h4>

    @if(User.Identity?.IsAuthenticated == true)
    {
        <form asp-action="Answer" asp-route-questionId="@Model.Question.Id" method="post">
            @Html.AntiForgeryToken()

            <div class="form-group mb-3">
                <textarea name="body" class="form-control" rows="6" placeholder="Explain your answer in details..."></textarea>
                @if (ViewData.ModelState["answerbody"]?.Errors.Count > 0)
                {
                    <span class="text-danger">@ViewData.ModelState["answerbody"]?.Errors.First().ErrorMessage</span>
                }
            </div>

            <div class="form-group">
                <input class="btn btn-primary" type="submit" value="Post your answer" />
            </div>
        </form>
    }
    else
    {
        <div class="mb-3">
            <span>Please log in to post answers</span> - <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path"> Login</a>
        </div>
    }

    @section Scripts {
        <script>
            function handleOpen(id){
                document.getElementById(`answer-body-${id}`).style.display = "none";
                document.getElementById(`answer-form-${id}`).style.display = "block";
            }

            function handleClose(id){
                document.getElementById(`answer-body-${id}`).style.display = "block";
                document.getElementById(`answer-form-${id}`).style.display = "none";
            }

            document.addEventListener('DOMContentLoaded', function () {
                const questionArrow = document.getElementById('toggle-comments-arrow');
                const questionCommentsSection = document.getElementById('comments-section');
                let questionCommentsVisible = true;

                if (questionArrow && questionCommentsSection) {
                    questionArrow.addEventListener('click', function () {
                        questionCommentsVisible = !questionCommentsVisible;
                        questionCommentsSection.style.display = questionCommentsVisible ? 'block' : 'none';
                        questionArrow.innerHTML = questionCommentsVisible
                            ? '<i class="fa-solid fa-caret-down"></i>'
                            : '<i class="fa-solid fa-caret-right"></i>';
                    });
                }

                document.querySelectorAll(".answer-comments-section").forEach(section => {
                    const id = section.getAttribute('answer-id');
                    const arrow = document.getElementById(`toggle-arrow-${id}`);
                    const commentsSection = document.getElementById(`comments-section-answer-${id}`);
                    let commentsVisible = true;

                    if (arrow && commentsSection) {
                        arrow.addEventListener('click', function () {
                            commentsVisible = !commentsVisible;
                            commentsSection.style.display = commentsVisible ? 'block' : 'none';
                            arrow.innerHTML = commentsVisible
                                ? '<i class="fa-solid fa-caret-down"></i>'
                                : '<i class="fa-solid fa-caret-right"></i>';
                        });
                    }
                });
            });

            document.addEventListener('DOMContentLoaded', function () {
                        document.querySelectorAll('.vote-link').forEach((link, i) => {
                            link.addEventListener('click', async function (e) {
                                e.preventDefault();

                                const type = this.dataset.type;
                                const id = parseInt(this.dataset.id);
                                const vote = parseInt(this.dataset.vote);

                                if(vote == 1){
                                    document.querySelectorAll('.vote-link')[i].getElementsByTagName('i')[0].style.color = 'grey';
                                    document.querySelectorAll('.vote-link')[i+1].getElementsByTagName('i')[0].style.color = 'lightgrey';
                                }
                                else {
                                    document.querySelectorAll('.vote-link')[i].getElementsByTagName('i')[0].style.color = 'grey';
                                    document.querySelectorAll('.vote-link')[i-1].getElementsByTagName('i')[0].style.color = 'lightgrey';
                                }

                                try {
                                    const response = await fetch(`/Votes/${type}?${type}Id=${id}&voteType=${vote}`, {
                                        method: 'POST',
                                        headers: {
                                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                                        }
                                    });

                                    if (response.ok) {
                                        const result = await response.json();
                                        console.log(result);
                                        document.getElementById(`${type}-score-${id}`).textContent = result.newScore;
                                    } else {
                                        alert('Failed to register vote. You may have already voted.');
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    alert('An error occurred while voting.');
                                }
                            });
                        });
                    });
        </script>
    }
</div>
