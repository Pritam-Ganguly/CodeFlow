@model (CodeFlow.core.Models.Question Question, IEnumerable<CodeFlow.core.Models.Answer> Answers)

@{
    ViewData["Title"] = Model.Question.Title;
}

<div class="container mt-4">
    <div class="so-question-card mb-4">
        <div class="so-question-body row">
            <div class="row">
                <div class="col-14 so-question-title">@Model.Question.Title</div>
            </div>
            <div class="row justify-content-start">
                <div class="col-6 so-question-postdate">
                    Asked on @Model.Question.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt") by <strong>@Model.Question.User?.DisplayName</strong>
                </div>
                <div class="col-4 so-question-postdate">
                    <span class="">Viewed: @Model.Question.ViewCount times</span>
                </div>
            </div>
            <hr />
            <div class="col-1">
                @if (!User.Identity!.IsAuthenticated)
                {
                    <a class="text-decoration-none" asp-controller="Account" asp-action="Login">
                        <i class="fa-solid fa-caret-up fa-2x text-muted"></i>
                    </a>
                    <div class="score fs-5 fw-bold my-1 ps-1" id="question-score-@Model.Question.Id">@Model.Question.Score</div>
                    <a class="text-decoration-none" asp-controller="Account" asp-action="Login">
                        <i class="fas fa-caret-down fa-2x text-muted"></i>
                    </a>
                }
                else
                {
                    <a href="#" class="vote-link text-decoration-none" data-type="question" data-id="@Model.Question.Id" data-vote="1">
                        <i class="fa-solid fa-caret-up fa-2x text-muted"></i>
                    </a>
                    <div class="score fs-5 fw-bold my-1 ps-1" id="question-score-@Model.Question.Id">@Model.Question.Score</div>
                    <a href="#" class="vote-link text-decoration-none" data-type="question" data-id="@Model.Question.Id" data-vote="-1">
                        <i class="fas fa-caret-down fa-2x text-muted"></i>
                    </a>
                }
            </div>
            <div class="col-10 pb-5">
                <div class="question-body">
                    @Model.Question.Body
                </div>
            </div>
            <div class="row row justify-content-start">
                <div class="col-5 mt-2 mb-3">
                    @foreach (var tag in Model.Question.Tags)
                    {
                        <span class="so-question-badge badge bg-light text-dark">@tag.Name</span>
                    }
                </div>
            </div>
        </div>
    </div>

    <h2>@Model.Answers.Count() Answers</h2>
    <hr />
    @if (Model.Answers.Any())
    {
        foreach(var answer in Model.Answers)
        {
            <div class="card mb-3">
                <div class="card-body row">
                    <div class="col-1">
                        @if (!User.Identity!.IsAuthenticated)
                        {
                            <a class="text-decoration-none" asp-controller="Account" asp-action="Login">
                                <i class="fa-solid fa-caret-up fa-2x text-muted"></i>
                            </a>
                            <div class="score fs-5 fw-bold my-1 ps-1" id="answer-score-@answer.Id">@answer.Score</div>
                            <a class="text-decoration-none" asp-controller="Account" asp-action="Login">
                                <i class="fas fa-caret-down fa-2x text-muted"></i>
                            </a>
                        }
                        else
                        {
                            <a href="#" class="vote-link text-decoration-none" data-type="answer" data-id="@answer.Id" data-vote="1">
                                <i class="fa-solid fa-caret-up fa-2x text-muted"></i>
                            </a>
                            <div class="score fs-5 fw-bold my-1 ps-1" id="answer-score-@answer.Id">@answer.Score</div>
                            <a href="#" class="vote-link text-decoration-none" data-type="answer" data-id="@answer.Id" data-vote="-1">
                                <i class="fas fa-caret-down fa-2x text-muted"></i>
                            </a>
                        }
                    </div>
                    <div class="col-10 answer-body">
                        @answer.Body
                    </div>
                    <div class="col-md-7 offset-md-5 text-muted mt-2 justify-content-end">
                        Answered by <strong>@answer.User?.DisplayName</strong> on @answer.CreatedAt.ToString("MMM dd, yyyy")

                        @if (answer.IsAccepted)
                        {
                            <span class="badge bg-success ms-2">Accepted</span>
                        }
                    </div>
                </div>
            </div>
        }        
    }
    else
    {
        <p class="text-muted">No answers yet. Be the first to answer</p>
    }
</div>
<div class="mt-5">
    <h3>Youre Answer</h3>
    <form asp-action="Answer" asp-route-id="@Model.Question.Id" method="post">
        @Html.AntiForgeryToken()

        <div class="form-group mb-3">
            <textarea name="body" class="form-control" rows="6" placeholder="Explain your answer in details..."></textarea>
            @if(ViewData.ModelState["body"]?.Errors.Count > 0)
            {
                <span class="text-danger">@ViewData.ModelState["body"]?.Errors.First().ErrorMessage</span>
            }
            else if(ViewData.ModelState[string.Empty]?.Errors.Count > 0)
            {
                <span class="text-danger">@ViewData.ModelState[string.Empty]?.Errors.First().ErrorMessage</span>
            }
        </div>

        <div class="form-group">
            <input class="btn btn-primary" type="submit" value="Post your answer"/>
        </div>
    </form>

    @section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                        // Attach click event to all vote links
                        document.querySelectorAll('.vote-link').forEach(link => {
                            link.addEventListener('click', async function (e) {
                                e.preventDefault(); // Prevent the link from navigating

                                const type = this.dataset.type; // 'question' or 'answer'
                                const id = parseInt(this.dataset.id);
                                const vote = parseInt(this.dataset.vote); // 1 or -1
                                console.log(`Voting ${vote} on ${type} with ID ${id}`);

                                try {
                                    const response = await fetch(`/Votes/${type}?${type}Id=${id}&voteType=${vote}`, {
                                        method: 'POST',
                                        headers: {
                                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                                        }
                                    });

                                    if (response.ok) {
                                        const result = await response.json();
                                        console.log(result);
                                        document.getElementById(`${type}-score-${id}`).textContent = result.newScore;
                                    } else {
                                        alert('Failed to register vote. You may have already voted.');
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    alert('An error occurred while voting.');
                                }
                            });
                        });
                    });
        </script>
    }

</div>


