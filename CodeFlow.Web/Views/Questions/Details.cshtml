@model (CodeFlow.core.Models.Question Question, IEnumerable<CodeFlow.core.Models.Answer> Answers)

@{
    ViewData["Title"] = Model.Question.Title;
}

<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <a href="#" class="vote-link text-decoration-none" data-type="question" data-id="@Model.Question.Id" data-vote="1">
                    <i class="fas fa-caret-up fa-2x @(Model.Question.Score > 0 ? "text-sucess" : "text-muted")"></i>
                </a>
                <div class="score fs-5 fw-bold my-1" id="question-score-@Model.Question.Id">@Model.Question.Score</div>
                <a href="#" class="vote-link text-decoration-none" data-type="question" data-id="@Model.Question.Id" data-vote="-1">
                    <i class="fas fa-caret-up fa-2x @(Model.Question.Score > 0 ? "text-danger" : "text-muted")"></i>
                </a>
            </div>
            <div class="col-11">
                <h1 class="card-title">@Model.Question.Title</h1>
                <div class="text-muted mb-3">
                    Asked on @Model.Question.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt") by <strong>@Model.Question.User?.DisplayName</strong>
                </div>
                <div class="question-body">
                    @Model.Question.Body
                </div>
                <div class="mt-3">
                    <span class="badge bg-secondary">Score: @Model.Question.Score</span>
                    <span class="badge bg-light text-dark">@Model.Question.ViewCount</span>
                </div>
            </div>
            <div class="mt-2 mb-3">
                @foreach(var tag in Model.Question.Tags)
                {
                    <span class="badge bg-primary">@tag.Name</span>
                }
            </div>
        </div>
    </div>

    <h2>@Model.Answers.Count() Answers</h2>
    <hr />
    @if (Model.Answers.Any())
    {
        foreach(var answer in Model.Answers)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <div class="answer-body">
                        @answer.Body
                    </div>
                    <div class="text-muted mt-2">
                        Answered by <strong>@answer.User?.DisplayName</strong> on @answer.CreatedAt.ToString("MMM dd, yyyy")

                        @if (answer.IsAccepted)
                        {
                            <span class="badge bg-success ms-2">Accepted</span>
                        }
                    </div>
                    <span class="badge bg-secondary">Score: @answer.Score</span>
                </div>
                <div>

                </div>
            </div>
        }        
    }
    else
    {
        <p class="text-muted">No answers yet. Be the first to answer</p>
    }
</div>
<div class="mt-5">
    <h3>Youre Answer</h3>
    <form asp-action="Answer" asp-route-id="@Model.Question.Id" method="post">
        @Html.AntiForgeryToken()

        <div class="form-group mb-3">
            <textarea name="body" class="form-control" rows="6" placeholder="Explain your answer in details..."></textarea>
            @if(ViewData.ModelState["body"]?.Errors.Count > 0)
            {
                <span class="text-danger">@ViewData.ModelState["body"]?.Errors.First().ErrorMessage</span>
            }
            else if(ViewData.ModelState[string.Empty]?.Errors.Count > 0)
            {
                <span class="text-danger">@ViewData.ModelState[string.Empty]?.Errors.First().ErrorMessage</span>
            }
        </div>

        <div class="form-group">
            <input class="btn btn-primary" type="submit" value="Post your answer"/>
        </div>
    </form>

    @section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                        // Attach click event to all vote links
                        document.querySelectorAll('.vote-link').forEach(link => {
                            link.addEventListener('click', async function (e) {
                                e.preventDefault(); // Prevent the link from navigating

                                const type = this.dataset.type; // 'question' or 'answer'
                                const id = parseInt(this.dataset.id);
                                const vote = parseInt(this.dataset.vote); // 1 or -1

                                try {
                                    const response = await fetch(`/Votes/${type}?${type}Id=${id}&voteType=${vote}`, {
                                        method: 'POST',
                                        headers: {
                                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                                        }
                                    });

                                    if (response.ok) {
                                        const result = await response.json();
                                        // Update the score on the page
                                        document.getElementById(`${type}-score-${id}`).textContent = result.newScore;
                                    } else {
                                        alert('Failed to register vote. You may have already voted.');
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    alert('An error occurred while voting.');
                                }
                            });
                        });
                    });
        </script>
    }

</div>


